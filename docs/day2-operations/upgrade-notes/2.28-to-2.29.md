# Kubespray 2.28.x → 2.29.x 업그레이드 노트

## 개요

| 항목 | 2.28.1 | 2.29.1 |
|------|--------|--------|
| Kubernetes 기본 버전 | 1.32.x | 1.33.x |
| Cilium | 1.17.7 | 1.18.4 |
| Flannel | 0.22.0 | 0.27.3 |
| Multus | 4.1.0 | 4.2.2 |

## Breaking Changes

### 1. Weave CNI 제거

Weave 네트워크 플러그인이 완전히 제거되었습니다.

**영향받는 경우:**
- `kube_network_plugin: weave` 사용 중인 클러스터

**조치:**
- Weave를 사용 중이라면 다른 CNI로 마이그레이션 필요 (Calico, Cilium 등)
- custom-config.yml에서 `weave_password` 등 weave 관련 변수 제거

### 2. kube_proxy_mode 옵션 추가

`nftables` 옵션이 새로 추가되었습니다.

```yaml
# 사용 가능한 옵션
kube_proxy_mode: ipvs      # 기본값
kube_proxy_mode: iptables
kube_proxy_mode: nftables  # 신규
```

## 변수 변경사항

### 추가된 변수

| 변수명 | 기본값 | 설명 |
|--------|--------|------|
| `kubeadm_image_repo` | `{{ kube_image_repo }}` | kubeadm 이미지 저장소 |
| `containerd_static_binary` | `false` | 정적 containerd 바이너리 사용 |
| `prometheus_operator_crds_enabled` | `false` | Prometheus Operator CRD 설치 |
| `sysctl_ignore_unknown_keys` | `false` | 알 수 없는 sysctl 키 무시 |

### 제거된 변수

| 변수명 | 설명 |
|--------|------|
| `weave_password` | Weave 네트워크 암호 |
| `weave_version` | Weave 버전 |
| `weave_kube_image_repo` | Weave 이미지 저장소 |
| `weave_kube_image_tag` | Weave 이미지 태그 |
| `weave_npc_image_repo` | Weave NPC 이미지 저장소 |
| `weave_npc_image_tag` | Weave NPC 이미지 태그 |

### 변경된 변수

| 변수명 | 2.28.1 | 2.29.1 |
|--------|--------|--------|
| `netcheck_etcd_image_tag` | `v3.4.17` | `{{ etcd_image_tag }}` (동적) |

## 버전 업데이트

### 컨테이너 이미지 버전

| 컴포넌트 | 2.28.1 | 2.29.1 |
|----------|--------|--------|
| Cilium | 1.17.7 | 1.18.4 |
| Cilium Hubble Certgen | v0.2.1 | v0.2.4 |
| Cilium Hubble UI | v0.13.2 | v0.13.3 |
| Cilium Hubble Envoy | v1.32.5-... | v1.34.10-... |
| Flannel | 0.22.0 | 0.27.3 |
| Flannel CNI | 1.1.2 | 1.7.1-flannel1 |
| Multus | 4.1.0 | 4.2.2 |
| Nginx (LB) | 1.27.4-alpine | 1.28.0-alpine |
| HAProxy (LB) | 3.1.3-alpine | 3.2.4-alpine |

### 바이너리 버전

동일 버전 유지 (Kubernetes 버전에 따라 자동 결정)

## 오프라인 환경 주의사항

### 1. 파일 서버 업데이트

새 버전의 바이너리 파일을 파일 서버에 추가해야 합니다.

```bash
# 새 버전 파일 다운로드 및 업로드
cd kubespray-2.29.1/contrib/offline
bash generate_list.sh
export FILES_LIST=temp/files.list
NO_HTTP_SERVER=true bash manage-offline-files.sh

# 파일 서버에 v2.29.1 디렉토리로 업로드
scp offline-files.tar.gz root@<repo-server>:/root/
ssh root@<repo-server>
mkdir -p /root/offline-files/v2.29.1
tar -xvf offline-files.tar.gz --strip-components=1 -C /root/offline-files/v2.29.1
```

### 2. custom-config.yml 업데이트

`kubespray_version` 변수를 업데이트합니다:

```yaml
# 변경 전
kubespray_version: "v2.28.1"

# 변경 후
kubespray_version: "v2.29.1"
```

### 3. 새로운 이미지 확인

프록시 레지스트리가 새 버전의 이미지를 캐시할 수 있도록 확인합니다.

새로 추가되거나 버전이 변경된 주요 이미지:
- `quay.io/cilium/cilium:v1.18.4`
- `quay.io/cilium/operator:v1.18.4`
- `ghcr.io/k8snetworkplumbingwg/multus-cni:v4.2.2`
- `docker.io/flannel/flannel:v0.27.3`

### 4. Prometheus Operator CRD (선택사항)

2.29.1에서 `prometheus_operator_crds_enabled` 옵션이 추가되었습니다.
이 기능을 사용하려면 추가 파일 다운로드가 필요합니다:

```yaml
# custom-config.yml에 추가 (선택사항)
prometheus_operator_crds_enabled: true
```

## custom-config.yml 마이그레이션 체크리스트

| # | 항목 | 확인 |
|---|------|------|
| 1 | `weave_*` 관련 변수 제거 (사용 중이었다면) | ☐ |
| 2 | `kubespray_version` 업데이트 | ☐ |
| 3 | 새 버전 파일 서버 업로드 | ☐ |
| 4 | 새 버전 이미지 프록시 확인 | ☐ |

## 알려진 이슈

### --check 모드 제한사항

`ansible-playbook --check` 모드로 실행 시, 다음 태스크에서 실패할 수 있습니다:

```
TASK [download : Prep_kubeadm_images | Copy kubeadm binary from download dir to system path]
fatal: [...]: FAILED! => {"msg": "Source /tmp/releases/kubeadm-x.x.x-amd64 not found"}
```

**원인:** `--check` 모드는 실제 파일을 다운로드하지 않으므로, 복사 태스크에서 소스 파일을 찾을 수 없습니다.

**해결:** 이는 예상된 동작입니다. 실제 업그레이드 시에는 다운로드가 먼저 수행되므로 문제가 없습니다.

## 참고 자료

- [Kubespray v2.29.1 Release Notes](https://github.com/kubernetes-sigs/kubespray/releases/tag/v2.29.1)
- [Kubernetes 1.33 Release Notes](https://kubernetes.io/blog/)

